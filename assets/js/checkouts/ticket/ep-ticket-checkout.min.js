/* jshint es3: false */
/* globals wc_epayco_ticket_checkout_params, CheckoutTicketElements, CheckoutTicketPage */
(function ($) {
    'use strict';

    $(function () {
        var epayco_submit_ticket = false;

        // Handler form submit
        function epaycoFormHandlerTicket() {
            if (!document.getElementById('payment_method_woo-epayco-ticket').checked) {
                return true;
            }
            let ticketContent = document.querySelector("form.checkout").getElementsByClassName("ep-checkout-ticket-content")[0];
            //let ticketContent = document.querySelector(CheckoutTicketElements.ticketContent);
            let ticketHelpers = ticketContent.querySelectorAll('input-helper');

            const ticketName = document.getElementsByName('epayco_ticket[name]')[0]??document.getElementsByName('epayco_ticket[nameError]')[0];
            const ticketContentName = ticketName.value;
            const nameHelpers =  ticketContent.querySelector('input-helper-epayco').querySelector("div");
            verifyName(ticketContent,ticketContentName, nameHelpers)

            const ticketContentEmail = document.getElementsByName('epayco_ticket[email]')[0].value;
            const emailHelpers =  ticketContent.querySelector('input-email-epayco').querySelector("input-helper-epayco").querySelector("div");
            verifyEmail(ticketContent,ticketContentEmail,emailHelpers)
            //verifyAddress(ticketContent)
            const cellphoneType = document.getElementsByName('epayco_ticket[cellphone]')[0].value;
            const ticketContentCellphone = document.getElementsByName('epayco_ticket[cellphoneType]')[0].value;
            const cellphoneHelpers =  ticketContent.querySelector('input-cellphone-epayco').querySelector("input-helper-epayco").querySelector("div");
            verifyCellphone(ticketContent,cellphoneType,cellphoneHelpers)

            const doc_type = document.getElementsByName('epayco_ticket[documentType]')[0].value;
            const documentHelpers =  ticketContent.querySelector('input-document-epayco').querySelector("input-helper-epayco").querySelector("div");
            const doc_number = document.getElementsByName('epayco_ticket[document]').length>0?document.getElementsByName('epayco_ticket[document]'):document.getElementsByName('documentTypeError');
            const doc_number_value = doc_number[0].value;
            verifyDocument(ticketContent,doc_number_value, documentHelpers);
            //verifyCountry(ticketContent)
            //verifyPaymentMethods(ticketContent);
            const country_type = document.getElementsByName('epayco_ticket[countryType]')[0].value;
            const countryHelpers =  ticketContent.querySelector('input-country-epayco').querySelector("input-helper-epayco").querySelector("div");
            const country = document.getElementsByName('epayco_ticket[country]').length>0?document.getElementsByName('epayco_ticket[country]'):document.getElementsByName('documentTypeError');
            const country_value = country[0].value;
            verifyCountry(ticketContent,country_value, countryHelpers);

            var paymentOptionSelected;
            const paymentselpers =  document.querySelector(".ep-checkout-ticket-container").querySelectorAll(".ep-input-radio-radio")[0].parentElement.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.parentNode.querySelector('input-helper-epayco').querySelector('div');
            document.querySelector(".ep-checkout-ticket-container").querySelectorAll(".ep-input-radio-radio").forEach((e => {
                if (e.checked) {
                    paymentOptionSelected = e.value;
                }
            }))
            if(paymentOptionSelected !==''&& paymentOptionSelected !== undefined){
                //ticketContent.querySelector('input-table-epayco').parentElement.classList.remove("ep-error");
                paymentselpers.style.display = 'none';
                //nn["epayco_ticket[payment_method_id]"] = paymentOptionSelected;
            }else{
                //ticketContent.querySelector('input-table-epayco').parentElement.classList.add("ep-error");
                paymentselpers.style.display = 'flex';
            }
            verifyTermAndCondictions(ticketContent)
            let checked =  ticketContent.parentElement.querySelector('terms-and-conditions').querySelector('input').checked
            if (checkForErrors(ticketHelpers) || !checked) {
                removeBlockOverlay();
            } else {
                epayco_submit_ticket = true;
            }

            return epayco_submit_ticket;
        }

        function checkForErrors(ticketHelpers) {
            let hasError = false;

            ticketHelpers.forEach((item) => {
                let inputHelper = item.querySelector('div');
                if (inputHelper.style.display !== 'none') {
                    hasError = true;
                }
            });

            return hasError;
        }

        function verifyName(ticketContent,ticketContentName, nameHelpers) {
            if (ticketContentName === '' || ticketContentName.length < 2) {
                ticketContent.querySelector('input-name-epayco').querySelector(".ep-input").classList.add("ep-error");
                nameHelpers.style.display = 'flex';
            }
        }

        function verifyEmail(ticketContent,ticketContentEmail,emailHelpers) {
            if (ticketContentEmail === '') {
                ticketContent.querySelector('input-email-epayco').querySelector(".ep-input").classList.add("ep-error");
                emailHelpers.style.display = 'flex';
            }
        }

        function verifyAddress(ticketContent) {
            let addressElement = ticketContent.querySelector('#form-checkout__identificationAddress-container').querySelector('input');
            if (addressElement.value === '') {
                addressElement.parentElement.classList.add('ep-error');
                let pseHelpers = ticketContent.querySelector('#form-checkout__identificationAddress-container').parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function verifyCellphone(ticketContent,cellphoneType,cellphoneHelpers) {
            if (cellphoneType === '') {
                ticketContent.querySelector('input-cellphone-epayco').querySelector(".ep-input").classList.add("ep-error");
                ticketContent.querySelector('input-cellphone-epayco').querySelector(".ep-input").parentElement.lastChild.classList.add("ep-error");
                cellphoneHelpers.style.display = 'flex';
            }
        }

        function verifyDocument(ticketContent,ticketContentDocument, documentHelpers) {
            if (ticketContentDocument === '') {
                ticketContent.querySelector('input-document-epayco').querySelector(".ep-input").classList.add("ep-error");
                ticketContent.querySelector('input-document-epayco').querySelector(".ep-input").parentElement.lastChild.classList.add("ep-error");
                documentHelpers.style.display = 'flex';
            }
        }

        function verifyCountry(ticketContent,ticketContentCountry, countryHelpers) {
            if (ticketContentCountry === '') {
                ticketContent.querySelector('input-country-epayco').querySelector(".ep-input").classList.add("ep-error");
                ticketContent.querySelector('input-country-epayco').querySelector(".ep-input").parentElement.lastChild.classList.add("ep-error");
                countryHelpers.style.display = 'flex';
            }
        }
/*
        function verifyCountry(ticketContent) {
            let addressElement = ticketContent.querySelector('#form-checkout__identificationCountry-container').querySelector('input');
            if (addressElement.value === '') {
                addressElement.parentElement.classList.add("ep-error");
                addressElement.parentElement.parentElement.firstChild.classList.add("ep-error");
                let pseHelpers = ticketContent.querySelector('#form-checkout__identificationCountry-container').parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }*/

        function verifyPaymentMethods(ticketContent) {
            let paymentOptionSelected = false;
            ticketContent.querySelectorAll('.ep-input-radio-radio').forEach((item) => {
                if (item.checked) {
                    paymentOptionSelected = true;
                }
            });

            if (paymentOptionSelected === false) {
                let documentElement = ticketContent.querySelector('.ep-checkout-ticket-payment-method');
                documentElement.querySelector("input-table > div").classList.add("ep-error")
                let pseHelpers = documentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }

            removeErrorFromInputTableContainer(ticketContent);
        }

        function removeErrorFromInputTableContainer(ticketContent) {
            ticketContent.querySelectorAll('.ep-input-table-label').forEach((item) => {
                item.addEventListener('click', () => {
                    let documentElement = ticketContent.querySelector('.ep-checkout-ticket-payment-method');
                    documentElement.querySelector("input-table > div").classList.remove("ep-error")
                    let pseHelpers = documentElement.querySelector('input-helper');
                    let child = pseHelpers.querySelector('div');
                    child.style.display = 'none';
                });
            });
        }

        function verifyTermAndCondictions(ticketContent) {
            let addressElement = ticketContent.parentElement.querySelector('terms-and-conditions').querySelector('input');
            if (!addressElement.checked) {
                ticketContent.parentElement.querySelector('terms-and-conditions > div').classList.add('ep-error')
            }
        }

        // Process when submit the checkout form
        $('form.checkout').on('checkout_place_order_woo-epayco-ticket', function () {
            return epaycoFormHandlerTicket();
        });

        // If payment fail, retry on next checkout page
        $('form#order_review').submit(function () {
            return epaycoFormHandlerTicket();
        });

        // Remove Block Overlay from Order Review page
        function removeBlockOverlay() {
            if ($('form#order_review').length > 0) {
                $('.blockOverlay').css('display', 'none');
            }
        }
    });
})(jQuery);
