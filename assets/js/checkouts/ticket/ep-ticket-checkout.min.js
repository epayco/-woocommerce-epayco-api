/* jshint es3: false */
/* globals wc_epayco_ticket_checkout_params, CheckoutTicketElements, CheckoutTicketPage */
(function ($) {
    'use strict';

    $(function () {
        var mercado_pago_submit_ticket = false;

        // Handler form submit
        function epaycoFormHandlerTicket() {
            if (!document.getElementById('payment_method_woo-epayco-ticket').checked) {
                return true;
            }
            let ticketContent = document.querySelector("form.checkout").getElementsByClassName("mp-checkout-ticket-content")[0];
            //let ticketContent = document.querySelector(CheckoutTicketElements.ticketContent);
            let ticketHelpers = ticketContent.querySelectorAll('input-helper');
            verifyName(ticketContent)
            verifyEmail(ticketContent)
            verifyAddress(ticketContent)
            cellphoneDocument(ticketContent)
            verifyDocument(ticketContent);
            verifyPaymentMethods(ticketContent);

            if (checkForErrors(ticketHelpers)) {
                removeBlockOverlay();
            } else {
                mercado_pago_submit_ticket = true;
            }

            return mercado_pago_submit_ticket;
        }

        function checkForErrors(ticketHelpers) {
            let hasError = false;

            ticketHelpers.forEach((item) => {
                let inputHelper = item.querySelector('div');
                if (inputHelper.style.display !== 'none') {
                    hasError = true;
                }
            });

            return hasError;
        }

        function verifyName(pseContent) {
            let nameElement = pseContent.querySelector('#form-checkout__identificationName-container').querySelector('input');
            if (nameElement.value === '') {
                nameElement.parentElement.classList.add('mp-error');
                let pseHelpers = pseContent.parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function verifyEmail(pseContent) {
            let emailElement = pseContent.querySelector('#form-checkout__identificationEmail-container').querySelector('input');
            if (emailElement.value === '') {
                emailElement.parentElement.classList.add('mp-error');
                let pseHelpers = pseContent.querySelector('#form-checkout__identificationEmail-container').parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function verifyAddress(pseContent) {
            let addressElement = pseContent.querySelector('#form-checkout__identificationAddress-container').querySelector('input');
            if (addressElement.value === '') {
                addressElement.parentElement.classList.add('mp-error');
                let pseHelpers = pseContent.querySelector('#form-checkout__identificationAddress-container').parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function cellphoneDocument(pseContent) {
            let addressElement = pseContent.querySelector('#form-checkout__identificationCellphone-container').querySelector('input');
            if (addressElement.value === '') {
                addressElement.parentElement.classList.add('mp-error');
                let pseHelpers = pseContent.querySelector('#form-checkout__identificationCellphone-container').parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function verifyDocument(pseContent) {
            let documentElement = pseContent.querySelector('.mp-document');
            if (documentElement.value === '') {
                pseContent.querySelector('.mp-input-document > div').classList.add('mp-error');
                //pseContent.querySelector('.mp-input').classList.add('mp-error');
                let pseHelpers = pseContent.querySelector('.mp-input-document').querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function verifyPaymentMethods(ticketContent) {
            ticketContent.querySelector('#more-options').addEventListener('click', () => {
                setTimeout(() => {
                    removeErrorFromInputTableContainer(ticketContent);
                }, 300);
            });

            let paymentOptionSelected = false;
            ticketContent.querySelectorAll('.mp-input-radio-radio').forEach((item) => {
                if (item.checked) {
                    paymentOptionSelected = true;
                }
            });

            if (paymentOptionSelected === false) {
                CheckoutTicketPage.setDisplayOfError('fcInputTableContainer', 'add', 'mp-error', 'ticketContent');
                CheckoutTicketPage.setDisplayOfInputHelper('mp-payment-method', 'flex', 'ticketContent');
            }

            removeErrorFromInputTableContainer(ticketContent);
        }

        function removeErrorFromInputTableContainer(ticketContent) {
            ticketContent.querySelectorAll('.mp-input-table-label').forEach((item) => {
                item.addEventListener('click', () => {
                    CheckoutTicketPage.setDisplayOfError('fcInputTableContainer', 'remove', 'mp-error', 'ticketContent');
                    CheckoutTicketPage.setDisplayOfInputHelper('mp-payment-method', 'none', 'ticketContent');
                });
            });
        }

        // Process when submit the checkout form
        $('form.checkout').on('checkout_place_order_woo-epayco-ticket', function () {
            return epaycoFormHandlerTicket();
        });

        // If payment fail, retry on next checkout page
        $('form#order_review').submit(function () {
            return epaycoFormHandlerTicket();
        });

        // Remove Block Overlay from Order Review page
        function removeBlockOverlay() {
            if ($('form#order_review').length > 0) {
                $('.blockOverlay').css('display', 'none');
            }
        }
    });
})(jQuery);
