/* globals wc_epayco_custom_checkout_params, epayco, CheckoutPage, MP_DEVICE_SESSION_ID */

var cardForm;
var hasToken = false;
var mercado_pago_submit = false;
var triggeredPaymentMethodSelectedEvent = false;
var cardFormMounted = false;
var threedsTarget = 'mp_custom_checkout_security_fields_client';

var mpCheckoutForm = document.querySelector('form[name=checkout]');
var mpFormId = 'checkout';

if (mpCheckoutForm) {
    mpCheckoutForm.id = mpFormId;
} else {
    mpFormId = 'order_review';
}

async function  epaycoFormHandler(event) {
    debugger
    event.preventDefault();
    var publicKey = wc_epayco_custom_checkout_params.public_key_epayco;
    ePayco.setPublicKey(publicKey);
    ePayco.setLanguage("es");
    let formOrderReview = document.querySelector('form[id=order_review]');
    if (formOrderReview) {
        let choCustomContent = document.querySelector('.mp-checkout-custom-container');
        let choCustomHelpers = choCustomContent.querySelectorAll('input-helper');

        choCustomHelpers.forEach((item) => {
            let inputHelper = item.querySelector('div');
            if (inputHelper.style.display !== 'none') {
                removeBlockOverlay();
            }
        });
    }
    var CustomContent = document.querySelector("form.checkout").getElementsByClassName("mp-checkout-custom-container")[0];
    let ticketHelpers = CustomContent.querySelectorAll('input-helper');
    verifyName(CustomContent)
    verifyEmail(CustomContent)
    verifyAddress(CustomContent)
    cellphoneDocument(CustomContent)
    verifyDocument(CustomContent);
    if (checkForErrors(ticketHelpers)) {
        removeBlockOverlay();
        return mercado_pago_submit;
    } else {
        console.log("loading..",mpCheckoutForm)
        return await createToken(CustomContent);
    }

        /*if (mercado_pago_submit) {
            return true;
        }

    jQuery('#mp_checkout_type').val('custom');



    return false;*/
}

function checkForErrors(ticketHelpers) {
    let hasError = false;

    ticketHelpers.forEach((item) => {
        let inputHelper = item.querySelector('div');
        if (inputHelper.style.display !== 'none') {
            hasError = true;
        }
    });

    return hasError;
}

function verifyName(customContent) {
    let nameElement = customContent.querySelector('#form-checkout__identificationName-container').querySelector('input');
    if (nameElement.value === '') {
        nameElement.parentElement.classList.add('mp-error');
        let pseHelpers = nameElement.parentElement.parentElement.querySelector('input-helper');
        let child = pseHelpers.querySelector('div');
        child.style.display = 'flex';
    }
}

function verifyEmail(customContent) {
    let emailElement = customContent.querySelector('#form-checkout__identificationEmail-container').querySelector('input');
    if (emailElement.value === '') {
        emailElement.parentElement.classList.add('mp-error');
        let pseHelpers = customContent.querySelector('#form-checkout__identificationEmail-container').parentElement.querySelector('input-helper');
        let child = pseHelpers.querySelector('div');
        child.style.display = 'flex';
    }
}

function verifyAddress(customContent) {
    let addressElement = customContent.querySelector('#form-checkout__identificationAddress-container').querySelector('input');
    if (addressElement.value === '') {
        addressElement.parentElement.classList.add('mp-error');
        let pseHelpers = customContent.querySelector('#form-checkout__identificationAddress-container').parentElement.querySelector('input-helper');
        let child = pseHelpers.querySelector('div');
        child.style.display = 'flex';
    }
}

function cellphoneDocument(customContent) {
    let addressElement = customContent.querySelector('#form-checkout__identificationCellphone-container').querySelector('input');
    if (addressElement.value === '') {
        addressElement.parentElement.classList.add('mp-error');
        let pseHelpers = customContent.querySelector('#form-checkout__identificationCellphone-container').parentElement.querySelector('input-helper');
        let child = pseHelpers.querySelector('div');
        child.style.display = 'flex';
    }
}

function verifyDocument(customContent) {
    let documentElement = customContent.querySelector('.mp-document');
    if (documentElement.value === '') {
        customContent.querySelector('.mp-input-document > div').classList.add('mp-error');
        //customContent.querySelector('.mp-input').classList.add('mp-error');
        let pseHelpers = customContent.querySelector('.mp-input-document').querySelector('input-helper');
        let child = pseHelpers.querySelector('div');
        child.style.display = 'flex';
    }
}

function removeErrorFromInputTableContainer(DaviplataContent) {
    DaviplataContent.querySelectorAll('.mp-input-table-label').forEach((item) => {
        item.addEventListener('click', () => {
            CheckoutTicketPage.setDisplayOfError('fcInputTableContainer', 'remove', 'mp-error', 'CustomContent');
            CheckoutTicketPage.setDisplayOfInputHelper('mp-payment-method', 'none', 'CustomContent');
        });
    });
}

async function  createToken($form) {
    return await new Promise(function(resolve, reject) {
        ePayco.token.create($form, function(data) {
            debugger
            var customContent = document.querySelector("form.checkout").getElementsByClassName("mp-checkout-custom-container")[0];
            customContent.querySelector('#form-checkout__cardNumber-container').querySelector('input').value='';
            customContent.querySelector('#form-checkout__expirationDate-container').querySelector('input').value='';
            customContent.querySelector('#form-checkout__securityCode-container').querySelector('input').value='';
            if(data.status=='error'){
                const parsedError = handleCardFormErrors(data);
                console.error('ePayco cardForm error: ', parsedError);
                reject(false)
            }else{
                document.querySelector('#cardTokenId').value = data.data.token;
                //jQuery('form.checkout').submit();
                resolve(true)
            }
        });
    });
}






function removeBlockOverlay() {
    if (jQuery('form#order_review').length > 0) {
        jQuery('.blockOverlay').css('display', 'none');
    }
}


function handleCardFormErrors(cardFormErrors) {
    if (cardFormErrors.length) {
        const errors = [];
        cardFormErrors.forEach((e) => {
            errors.push(e.description || e.message);
        });

        return errors.join(',');
    }

    return cardFormErrors.description || cardFormErrors.message;
}

jQuery('form.checkout').on('checkout_place_order_woo-epayco-custom', function (event) {
        return epaycoFormHandler(event);
});

jQuery('body').on('payment_method_selected', function () {
    if (!triggeredPaymentMethodSelectedEvent) {
        //cardFormLoad();
    }
});

jQuery('form#order_review').submit(function (event) {
    const selectPaymentMethod = document.getElementById('payment_method_woo-epayco-custom');
    if (selectPaymentMethod && selectPaymentMethod.checked) {
        event.preventDefault();
        counter = true
        debugger
        //return epaycoFormHandler();
    }
});

jQuery(document.body).on('checkout_error', () => {
    hasToken = false;
    mercado_pago_submit = false;
});

if (!triggeredPaymentMethodSelectedEvent) {
    jQuery('body').trigger('payment_method_selected');
}

function createLoadSpinner() {
    document.querySelector('.mp-checkout-custom-container').style.display = 'none';
    document.querySelector('.mp-checkout-custom-load').style.display = 'flex';
}

function removeLoadSpinner() {
    document.querySelector('.mp-checkout-custom-container').style.display = 'block';
    document.querySelector('.mp-checkout-custom-load').style.display = 'none';
}



function removeElementsByClass(className) {
    const elements = document.getElementsByClassName(className);
    while (elements.length > 0) {
        elements[0].parentNode.removeChild(elements[0]);
    }
}

