/* jshint es3: false */
/* globals wc_epayco_pse_checkout_params,, CheckoutPseElements, CheckoutPsePage */
(function ($) {
    'use strict';

    $(function () {
        var epayco_submit_pse = false;

        // Handler form submit
        function epaycoFormHandlerPse() {
            if (!document.getElementById('payment_method_woo-epayco-pse').checked) {
                return true;
            }
            let pseContent = document.querySelector("form.checkout").getElementsByClassName("ep-checkout-pse-content")[0];
            //let pseContent = document.querySelector(CheckoutPseElements.pseContent);
            let pseHelpers = pseContent.querySelectorAll('input-helper');
            const nameHelpers =  pseContent.querySelector('input-helper-epayco').querySelector("div");
            const pseContentName = document.getElementsByName('epayco_pse[name]')[0].value;
            const pseContentEmail = document.getElementsByName('epayco_pse[email]')[0].value;
            const emailHelpers =  pseContent.querySelector('input-email-epayco').querySelector("input-helper-epayco").querySelector("div");
            const pseContentAddress = document.getElementsByName('epayco_pse[address]')[0].value;
            const addressHelpers =  pseContent.querySelector('input-address-epayco').querySelector("input-helper-epayco").querySelector("div");
            const cellphoneType = document.getElementsByName('epayco_pse[cellphone]')[0].value;
            const pseContentCellphone = document.getElementsByName('epayco_pse[cellphoneType]')[0].value;
            const cellphoneHelpers =  pseContent.querySelector('input-cellphone-epayco').querySelector("input-helper-epayco").querySelector("div");
            const doc_number = document.getElementsByName('epayco_pse[document]').length>0?document.getElementsByName('epayco_pse[document]'):document.getElementsByName('documentTypeError');
            const doc_number_value = doc_number[0].value;
            const doc_type = document.getElementsByName('epayco_pse[documentType]')[0].value;
            const documentHelpers =  pseContent.querySelector('input-document-epayco').querySelector("input-helper-epayco").querySelector("div");
            const pseContentCountry = document.getElementsByName('epayco_pse[country]')[0].value;
            const countryHelpers =  pseContent.querySelector('input-country-epayco').querySelector("input-helper-epayco").querySelector("div");
            const bank = document.getElementsByName('epayco_pse[bank]')[1].value;
            const bankHelper =  document.getElementsByName('epayco_pse[bank]')[0].querySelector('input-helper-epayco').querySelector('div');
            let checked =  pseContent.parentElement.querySelector('terms-and-conditions').querySelector('input').checked
            verifyName(pseContent,pseContentName, nameHelpers)
            verifyEmail(pseContent, pseContentEmail, emailHelpers)
            verifyAddress(pseContent, pseContentAddress, addressHelpers)
            verifyCellphone(pseContent, cellphoneType, cellphoneHelpers)
            verifyDocument(pseContent, doc_number_value, doc_type, documentHelpers);
            verifyCountry(pseContent,pseContentCountry, countryHelpers)
            verifyTermAndCondictions(pseContent)
            verifyBanks(pseContent, bank, bankHelper)
            // debugger
            if (checkForErrors(pseHelpers) || !checked || "0" === bank) {
                removeBlockOverlay();
            } else {
                epayco_submit_pse = true;
            }

            return epayco_submit_pse;
        }

        function checkForErrors(pseHelpers) {
            let hasError = false;

            pseHelpers.forEach((item) => {
                let inputHelper = item.querySelector('div');
                if (inputHelper.style.display !== 'none') {
                    hasError = true;
                }
            });

            return hasError;
        }

        function verifyName(pseContent, pseContentName,nameHelpers) {
            if (pseContentName === '') {
                pseContent.querySelector('input-name-epayco').querySelector(".ep-input").classList.add("ep-error");
                nameHelpers.style.display = 'flex';
            }
        }

        function verifyEmail(pseContent, pseContentEmail, emailHelpers) {
            if (pseContentEmail === '') {
                pseContent.querySelector('input-email-epayco').querySelector(".ep-input").classList.add("ep-error");
                emailHelpers.style.display = 'flex';
            }
        }

        function verifyAddress(pseContent, pseContentAddress, addressHelpers) {
            if (pseContentAddress === '') {
                pseContent.querySelector('input-address-epayco').querySelector(".ep-input").classList.add("ep-error");
                addressHelpers.style.display = 'flex';
            }
        }

        function verifyCellphone(pseContent, cellphoneType, cellphoneHelpers) {
            if (cellphoneType === '') {
                pseContent.querySelector('input-cellphone-epayco').querySelector(".ep-input").classList.add("ep-error");
                pseContent.querySelector('input-cellphone-epayco').querySelector(".ep-input").parentElement.lastChild.classList.add("ep-error");
                cellphoneHelpers.style.display = 'flex';
            }
        }

        function verifyDocument(pseContent, doc_number_value, doc_type, documentHelpers) {
            if (doc_number_value === '' || doc_type =='Tipo' || doc_type =='Type' ) {
                pseContent.querySelector('input-document-epayco').querySelector(".ep-input").classList.add("ep-error");
                pseContent.querySelector('input-document-epayco').querySelector(".ep-input").parentElement.lastChild.classList.add("ep-error");
                documentHelpers.style.display = 'flex';
            }
        }

        function verifyCountry(pseContent, pseContentCountry, countryHelpers) {
            if (pseContentCountry === '') {
                pseContent.querySelector('input-country-epayco').querySelector(".ep-input").classList.add("ep-error");
                pseContent.querySelector('input-country-epayco').querySelector(".ep-input").parentElement.lastChild.classList.add("ep-error");
                countryHelpers.style.display = 'flex';
            }
        }


        function removeErrorFromInputTableContainer(pseContent) {
            pseContent.querySelectorAll('.ep-input-table-label').forEach((item) => {
                item.addEventListener('click', () => {
                    let documentElement = pseContent.querySelector('.ep-checkout-pse-payment-method');
                    documentElement.querySelector("input-table > div").classList.remove("ep-error")
                    let pseHelpers = documentElement.querySelector('input-helper');
                    let child = pseHelpers.querySelector('div');
                    child.style.display = 'none';
                });
            });
        }

        function verifyTermAndCondictions(pseContent) {
            const termanAndContictionContent = document.querySelector('terms-and-conditions').querySelector('input');
            const termanAndContictionHelpers = pseContent.parentElement.querySelector('terms-and-conditions').querySelector(".ep-terms-and-conditions-container");
            //termanAndContictionContent.addEventListener('click', function() {
                if (!termanAndContictionContent.checked) {
                    //termanAndContictionHelpers.classList.add("ep-error")
                }
            //});
        }

        function verifyBanks(pseContent,bank,bankHelper){
            if("0" === bank){
                pseContent.querySelector('input-banks-epayco').querySelector(".ep-input-select-input").classList.add("ep-error");
                bankHelper.style.display = 'flex';
            }else{
                pseContent.querySelector('input-banks-epayco').querySelector(".ep-input-select-input").classList.remove("ep-error");
                bankHelper.style.display = 'none';
            }
        }

        // Process when submit the checkout form
        $('form.checkout').on('checkout_place_order_woo-epayco-pse', function () {
            return epaycoFormHandlerPse();
        });

        // If payment fail, retry on next checkout page
        $('form#order_review').submit(function () {
            return epaycoFormHandlerPse();
        });

        // Remove Block Overlay from Order Review page
        function removeBlockOverlay() {
            if ($('form#order_review').length > 0) {
                $('.blockOverlay').css('display', 'none');
            }
        }
    });
})(jQuery);
