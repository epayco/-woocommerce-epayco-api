function clearMessage() {
    document.querySelector(".mp-alert").remove()
}

function clearElement(e) {
    document.getElementById(e).remove()
}

function mpMsgElement(e, t, n, s, a, o) {
    const c = document.getElementById(e), i = document.createElement("div");
    i.className = "mp-card-info", i.id = e.concat("-card-info");
    const d = document.createElement("div");
    d.className = "mp-alert-color-".concat(o);
    const m = document.createElement("div");
    m.className = "mp-card-body-payments-error mp-card-body-size";
    const l = document.createElement("div");
    l.className = "mp-icon-badge-warning";
    const p = document.createElement("span");
    p.className = "mp-text-title", p.appendChild(document.createTextNode(t));
    const r = document.createElement("span");
    r.className = "mp-helper-test", r.appendChild(document.createTextNode(n));
    const u = document.createElement("div");
    if (u.appendChild(p), void 0 !== s) {
        const e = document.createElement("a");
        e.href = s, e.className = "mp-settings-blue-text", e.appendChild(document.createTextNode(a)), e.setAttribute("target", "_blank"), r.appendChild(e)
    }
    c.appendChild(i),
    u.appendChild(r),
    m.appendChild(l),
    m.appendChild(u),
    //i.appendChild(d),
    i.appendChild(m),
    "alert" === o && setTimeout(clearElement, 1e4, i.id)
}

function selectTestMode(e) {
    const t = document.getElementById("mp-mode-badge"), n = document.getElementById("mp-orange-badge"),
        s = document.getElementById("mp-icon-badge"), a = document.getElementById("mp-helper-test"),
        o = document.getElementById("mp-helper-prod"), c = document.getElementById("mp-title-helper-prod"),
        i = document.getElementById("mp-title-helper-test"), d = document.getElementById("mp-mode-badge-test"),
        m = document.getElementById("mp-mode-badge-prod");
    if (e) t.classList.remove("mp-settings-prod-mode-alert"), t.classList.add("mp-settings-test-mode-alert"), n.classList.remove("mp-settings-alert-payment-methods-green"), n.classList.add("mp-settings-alert-payment-methods-orange"), s.classList.remove("mp-settings-icon-success"), s.classList.add("mp-settings-icon-warning"), mpVerifyAlertTestMode(), a.style.display = "block", o.style.display = "none", i.style.display = "block", c.style.display = "none", d.style.display = "block", m.style.display = "none"; else {
        const e = document.getElementById("mp-red-badge").parentElement;
        t.classList.remove("mp-settings-test-mode-alert"), t.classList.add("mp-settings-prod-mode-alert"), e.style.display = "none", n.classList.remove("mp-settings-alert-payment-methods-orange"), n.classList.add("mp-settings-alert-payment-methods-green"), s.classList.remove("mp-settings-icon-warning"), s.classList.add("mp-settings-icon-success"), a.style.display = "none", o.style.display = "block", i.style.display = "none", c.style.display = "block", d.style.display = "none", m.style.display = "block"
    }
}

function mpVerifyAlertTestMode() {
    return !document.querySelector('input[name="mp-test-prod"]').checked || "" !== document.getElementById("mp-public-key-test").value && "" !== document.getElementById("mp-access-token-test").value ? (document.getElementById("mp-red-badge").parentElement.style.display = "none", !1) : (document.getElementById("mp-red-badge").parentElement.style.display = "flex", !0)
}

function mpShowMessage(e, t, n) {
    const s = document.createElement("div");
    let a = "", o = "";
    switch (n) {
        case"credentials":
            a = document.querySelector(".mp-message-credentials"), o = document.querySelector(".mp-heading-credentials");
            break;
        case"store":
            a = document.querySelector(".mp-message-store"), o = document.querySelector(".mp-heading-store");
            break;
        case"payment":
            a = document.querySelector(".mp-message-payment"), o = document.querySelector(".mp-heading-payment");
            break;
        case"test_mode":
            a = document.querySelector(".mp-message-test-mode"), o = document.querySelector(".mp-heading-test-mode");
            break;
        default:
            a = "", o = ""
    }
    s.className = "error" === t ? "mp-alert mp-alert-danger mp-text-center mp-card-body" : "mp-alert mp-alert-success mp-text-center mp-card-body", s.appendChild(document.createTextNode(e)), a.insertBefore(s, o), setTimeout(clearMessage, 3e3)
}

function mpValidateCredentialsTips() {
    const e = document.getElementById("mp-settings-icon-credentials");
    jQuery.post(ajaxurl, {
        action: "ep_validate_credentials_tips",
        nonce: epayco_settings_admin_js_params.nonce
    }, (function () {
    })).done((function (t) {
        t.success ? (e.classList.remove("mp-settings-icon-credentials"), e.classList.add("mp-settings-icon-success")) : e.classList.remove("mp-settings-icon-success")
    })).fail((function () {
        e.classList.remove("mp-settings-icon-success")
    }))
}

function mpValidatePaymentTips() {
    const e = document.getElementById("mp-settings-icon-payment");
    jQuery.post(ajaxurl, {
        action: "ep_validate_payment_tips",
        nonce: epayco_settings_admin_js_params.nonce
    }, (function () {
    })).done((function (t) {
        t.success ? (e.classList.remove("mp-settings-icon-payment"), e.classList.add("mp-settings-icon-success")) : e.classList.remove("mp-settings-icon-success")
    })).fail((function () {
        e.classList.remove("mp-settings-icon-success")
    }))
}

function mpGoToNextStep(e, t, n, s) {
    const a = document.getElementById(e), o = document.getElementById(n), c = document.getElementById(t),
        i = document.getElementById(s);
    if (a.style.display = "none", c.style.display = "block", o.classList.remove("mp-arrow-up"), i.classList.add("mp-arrow-up"), window.melidata && window.melidata.client && window.melidata.client.addStoreConfigurationsStepTimer) switch (t) {
        case"mp-step-2":
            window.melidata.client.addStoreConfigurationsStepTimer({step: "business"});
            break;
        case"mp-step-3":
            window.melidata.client.addStoreConfigurationsStepTimer({step: "payment_methods", sendOnClose: !0});
            break;
        case"mp-step-4":
            window.melidata.client.addStoreConfigurationsStepTimer({step: "mode"})
    }
}

function mpContinueToNextStep() {
    document.getElementById("mp-payment-method-continue").addEventListener("click", (function () {
        mpGoToNextStep("mp-step-3", "mp-step-4", "mp-payments-arrow-up", "mp-modes-arrow-up")
    }))
}

function mpGetRequirements() {
    jQuery.post(ajaxurl, {action: "mp_get_requirements", nonce: epayco_settings_admin_js_params.nonce}, (function (e) {
        const t = {
            ssl: document.getElementById("mp-req-ssl"),
            gd_ext: document.getElementById("mp-req-gd"),
            curl_ext: document.getElementById("mp-req-curl")
        };
        for (let n in t) {
            const s = t[n];
            s.style = "", e.data[n] || (s.classList.remove("mp-settings-icon-success"), s.classList.add("mp-settings-icon-warning"))
        }
    }))
}

function mpGetPaymentMethods() {
    jQuery.post(ajaxurl, {
        action: "ep_get_payment_methods",
        nonce: epayco_settings_admin_js_params.nonce
    }, (function (e) {
        const t = document.getElementById("mp-payment");
        document.querySelectorAll(".mp-settings-payment-block").forEach((e => {
            e.remove()
        })), e.data.reverse().forEach((e => {
            t.insertAdjacentElement("afterend", createMpPaymentMethodComponent(e))
        })), window.melidata && window.melidata.client && window.melidata.client.stepPaymentMethodsCallback && window.melidata.client.stepPaymentMethodsCallback()
    }))
}

function createMpPaymentMethodComponent(e) {
    const t = "yes" === e.enabled ? "mp-settings-badge-active" : "mp-settings-badge-inactive",
        n = "yes" === e.enabled ? e.badge_translator.yes : e.badge_translator.no, s = document.createElement("div");
    return s.appendChild(getPaymentMethodComponent(e, t, n)), s
}

function getPaymentMethodComponent(e, t, n) {
    const s = `\n    <a href="${e.link}" class="mp-settings-link mp-settings-font-color">\n      <div class="mp-block mp-block-flex mp-settings-payment-block mp-settings-align-div">\n        <div class="mp-settings-align-div">\n          <div class="mp-settings-icon">\n            <img src="${e.icon}" alt="mp gateway icon" />\n          </div>\n\n          <span class="mp-settings-subtitle-font-size mp-settings-margin-title-payment">\n            <b>${e.title_gateway}</b> - ${e.description}\n          </span>\n\n          <span class="${t}">${n}</span>\n        </div>\n\n        <div class="mp-settings-title-align">\n        <span class="mp-settings-text-payment">Configurar</span>\n          <div class="mp-settings-icon-config"></div>\n        </div>\n      </div>\n    </a>\n  `;
    return (new DOMParser).parseFromString(s, "text/html").firstChild
}

function mpSettingsAccordionStart() {
    let e;
    const t = document.getElementsByClassName("mp-settings-title-align");
    for (e = 0; e < t.length; e++) t[e].addEventListener("click", (function () {
        this.classList.toggle("active");
        {
            let e = null;
            for (let t = 0; t < this.childNodes.length; t++) if (this.childNodes[t]?.classList?.contains("mp-settings-margin-left")) {
                e = this.childNodes[t];
                break
            }
            e?.childNodes[1]?.classList?.toggle("mp-arrow-up")
        }
        const e = this.nextElementSibling;
        "block" === e.style.display ? e.style.display = "none" : e.style.display = "block"
    }))
}

function mpSettingsAccordionOptions() {
    const e = document.getElementById("mp-advanced-options"), t = document.getElementById("block-two");
    e.addEventListener("click", (function () {
        this.classList.toggle("active");
        const n = this.nextElementSibling;
        "block" === n.style.display ? n.style.display = "none" : n.style.display = "block", e.classList.contains("active") || t.classList.contains("mp-settings-flex-start") ? (e.textContent = epayco_settings_admin_js_params.hide_advanced_text, t.classList.remove("mp-settings-flex-start")) : (t.classList.toggle("mp-settings-flex-start"), e.textContent = epayco_settings_admin_js_params.show_advanced_text)
    }))
}

function mpValidateCredentials() {
    document
        .getElementById('mp-p_cust_id')
        .addEventListener('change', function () {
            const self = this;
            if (self.value.length<5) {
                self.classList.remove('mp-credential-feedback-positive');
                self.classList.add('mp-credential-feedback-negative');
            } else {
                self.classList.remove('mp-credential-feedback-negative');
                self.classList.add('mp-credential-feedback-positive');
            }
        });

    document
        .getElementById('mp-p_key')
        .addEventListener('change', function () {
            const self = this;
            if (self.value.length<39) {
                self.classList.remove('mp-credential-feedback-positive');
                self.classList.add('mp-credential-feedback-negative');
            } else {
                self.classList.remove('mp-credential-feedback-negative');
                self.classList.add('mp-credential-feedback-positive');
            }
        });

    document
        .getElementById('mp-publicKey')
        .addEventListener('change', function () {
            const self = this;
            if (self.value.length<31) {
                self.classList.remove('mp-credential-feedback-positive');
                self.classList.add('mp-credential-feedback-negative');
            } else {
                self.classList.remove('mp-credential-feedback-negative');
                self.classList.add('mp-credential-feedback-positive');
            }
        });

    document
        .getElementById('mp-private_key')
        .addEventListener('change', function () {
            const self = this;
            if (self.value.length<31) {
                self.classList.remove('mp-credential-feedback-positive');
                self.classList.add('mp-credential-feedback-negative');
            } else {
                self.classList.remove('mp-credential-feedback-negative');
                self.classList.add('mp-credential-feedback-positive');
            }
        });
}

function showLoading() {
    document.getElementById('credentials-setup').style.opacity = '0.5';
    document.getElementById('credentials-setup').style.pointerEvents = 'none'
    document.getElementById('mp-btn-credentials').style.opacity = '0.5';
    document.getElementById('mp-btn-credentials').style.pointerEvents = 'none'
    document.getElementById('loader').style.display = 'block';
}

function hideLoading() {
    document.getElementById('credentials-setup').style.opacity = '1';
    document.getElementById('credentials-setup').style.pointerEvents = 'all'
    document.getElementById('mp-btn-credentials').style.opacity = '1';
    document.getElementById('mp-btn-credentials').style.pointerEvents = 'all'
    document.getElementById('loader').style.display = 'none';
}

function mpUpdateOptionCredentials() {
    document
        .getElementById('mp-btn-credentials')
        .addEventListener('click', function () {
            const msgAlert = document.getElementById('msg-info-credentials');
            if (msgAlert.childNodes.length >= 1) {
                document.querySelector('.mp-card-info').remove();
            }
            showLoading();
            /*setTimeout(() => {
                hideLoading();
            }, 1000);
            setTimeout(() => {
                mpGoToNextStep('mp-step-1', 'mp-step-3', 'mp-credentials-arrow-up', 'mp-store-info-arrow-up');
            }, 2000);*/

            jQuery
                .post(
                    ajaxurl,
                    {
                        p_cust_id: document.getElementById('mp-p_cust_id').value,
                        p_key: document.getElementById('mp-p_key').value,
                        publicKey: document.getElementById('mp-publicKey').value,
                        private_key: document.getElementById('mp-private_key').value,
                        action: 'ep_update_option_credentials',
                        nonce: epayco_settings_admin_js_params.nonce,
                    },
                    function () {
                    }
                )
                .done(function (response) {
                    mpGetPaymentMethods();
                    if (response.success) {
                        mpVerifyAlertTestMode();
                        mpShowMessage(response.data, 'success', 'credentials');
                        mpValidateCredentialsTips();
                        hideLoading();
                        setTimeout(() => {
                            mpGoToNextStep('mp-step-1', 'mp-step-3', 'mp-credentials-arrow-up', 'mp-modes-arrow-up');
                        }, 1000);
                    } else {
                        const rad = document.querySelectorAll('input[name="mp-test-prod"]');
                        const { message, subtitle, link, linkMsg, type, test_mode } = response?.data;

                        mpMsgElement('msg-info-credentials', message, subtitle, link, linkMsg, type);

                        if (test_mode === 'no') {
                            rad[1].checked = true;
                            selectTestMode(false);
                        } else {
                            rad[0].checked = true;
                            selectTestMode(true);
                        }

                        setTimeout(() => {
                            hideLoading();
                        }, 1000);
                    }
                })
                .fail(function (error) {
                    debugger
                    hideLoading();
                    mpShowMessage(error?.data, 'error', 'credentials');
                });
        });
}

function mpUpdateTestMode() {
    const rad = document.querySelectorAll('input[name="mp-test-prod"]');

    rad[0].addEventListener('change', function () {
        if (rad[0].checked) {
            selectTestMode(true);
        }
    });

    rad[1].addEventListener('change', function () {
        if (rad[1].checked) {
            selectTestMode(false);
        }
    });

    document
        .getElementById('mp-store-mode-save')
        .addEventListener('click', function () {
            jQuery
                .post(
                    ajaxurl,
                    {
                        input_mode_value: document.querySelector('input[name="mp-test-prod"]:checked').value,
                        input_verify_alert_test_mode: mpVerifyAlertTestMode() ? 'yes' : 'no',
                        action: 'ep_update_test_mode',
                        nonce: epayco_settings_admin_js_params.nonce,
                    },
                    function () {
                    }
                )
                .done(function (response) {
                    if (response.success) {
                        mpShowMessage(response.data, 'success', 'test_mode');
                    } else {
                        mpShowMessage(response.data, 'error', 'test_mode');
                    }
                    setTimeout(() => {
                        mpGoToNextStep('mp-step-4', 'mp-step-5', 'mp-modes-arrow-up', 'mp-store-info-arrow-up');
                    }, 1000);
                })
                .fail(function (error) {
                    mpShowMessage(error.data, 'error', 'test_mode');
                });
        });
}

function mp_settings_screen_load() {
    mpGetPaymentMethods();
    mpSettingsAccordionStart();
    mpValidateCredentials();
    mpValidateCredentialsTips();
    mpValidatePaymentTips();
    mpVerifyAlertTestMode();
    mpUpdateOptionCredentials();
    mpUpdateTestMode();
    mpContinueToNextStep();
}

function openSupportModal() {
    document.getElementById("supportModal").style.display = "block"
}

function closeSupportModal() {
    document.getElementById("supportModal").style.display = "none"
}

document.addEventListener('DOMContentLoaded', function () {
    const checkboxes = document.querySelectorAll('input[name="selected_files[]"]');
    const downloadButton = document.getElementById('downloadSelected');
    const itemsPerPage = 8;
    let currentPage = 1;

    function updateTableDisplay() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;

        checkboxes.forEach((checkbox, index) => {
            checkbox.closest('tr').style.display = index >= startIndex && index < endIndex ? 'table-row' : 'none';
        });
    }

    updateTableDisplay();

    checkboxes.forEach((checkbox) => {
        checkbox.addEventListener('change', function () {
            let atLeastOneChecked = false;
            checkboxes.forEach((cb) => {
                if (cb.checked) {
                    atLeastOneChecked = true;
                }
            });
            downloadButton.disabled = !atLeastOneChecked;
        });
    });

    /*selectAllCheckbox.addEventListener('change', function () {
        checkboxes.forEach((checkbox) => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        downloadButton.disabled = !selectAllCheckbox.checked;
    });*/

});